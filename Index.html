<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    
    body { font-family: 'Cairo', sans-serif; background-color: #f0f2f5; }

    .stat-card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); }
    .bg-gradient-green { background: linear-gradient(45deg, #11998e, #38ef7d); color: white; }
    .bg-gradient-blue { background: linear-gradient(45deg, #2193b0, #6dd5ed); color: white; }
    .bg-gradient-red { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; }

    .data-card { background: white; border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 5px solid #11998e; }
    .data-card.has-issues { border-right: 5px solid #cb2d3e; background-color: #fff5f5; }

    .fab-btn { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background-color: #11998e; color: white; border-radius: 50%; text-align: center; line-height: 60px; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; }
    .fab-btn:hover { background-color: #0d7a71; }

    .form-control:focus { border-color: #11998e; box-shadow: 0 0 0 0.25rem rgba(17, 153, 142, 0.25); }

    #loadingSpinner { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index:2000; display:flex; flex-direction: column; justify-content: center; align-items: center; }
    
    .table-responsive { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

<div id="loadingSpinner">
  <div class="spinner-border text-success" role="status" style="width:3rem;height:3rem;"></div>
  <div class="mt-3 fw-bold text-success">جاري تحميل البيانات...</div>
</div>

<div class="container py-4">
  <div class="row mb-4 align-items-center">
    <div class="col-8">
      <h2 class="fw-bold text-dark"><i class="bi bi-tree-fill text-success"></i> نظام الإيجارات الزراعية</h2>
    </div>
    <div class="col-4 text-start">
      <button class="btn btn-outline-secondary btn-sm" onclick="loadData()"><i class="bi bi-arrow-clockwise"></i> تحديث</button>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4 col-12">
      <div class="card stat-card bg-gradient-green p-3">
        <h5><i class="bi bi-people"></i> عدد المستأجرين</h5>
        <h2 class="fw-bold" id="totalTenants">0</h2>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card stat-card bg-gradient-blue p-3">
        <h5><i class="bi bi-layers-fill"></i> إجمالي الأفدنة</h5>
        <h2 class="fw-bold" id="totalAcres">0</h2>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="card stat-card bg-gradient-red p-3">
        <h5><i class="bi bi-exclamation-triangle"></i> التعديات</h5>
        <h2 class="fw-bold" id="totalIssues">0</h2>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-4 shadow-sm border-0">
    <div class="row g-2">
      <div class="col-md-8">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input type="text" id="searchInput" class="form-control" placeholder="ابحث باسم المستأجر، الجريدة، أو الناحية...">
        </div>
      </div>
      <div class="col-md-4">
        <select id="filterIssue" class="form-select">
          <option value="all">كل الحالات</option>
          <option value="issue">يوجد تعديات</option>
          <option value="clean">بدون تعديات</option>
        </select>
      </div>
    </div>
  </div>

  <div id="dataContainer" class="row"></div>
</div>

<div class="fab-btn" data-bs-toggle="modal" data-bs-target="#dataModal" onclick="prepareAdd()">
  <i class="bi bi-plus-lg"></i>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="modalTitle">إضافة إيجار جديد</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="rentForm">
          <input type="hidden" id="rowIndex">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">رقم الجريدة</label><input type="text" class="form-control" id="journal" required></div>
            <div class="col-md-8"><label class="form-label">اسم المستأجر</label><input type="text" class="form-control" id="tenantName" required></div>
            <div class="col-md-6"><label class="form-label">الناحية</label><input type="text" class="form-control" id="district" required></div>
            <div class="col-md-2 col-4"><label class="form-label text-primary">فدان (إجمالي)</label><input type="number" class="form-control" id="feddan" value="0"></div>
            <div class="col-md-2 col-4"><label class="form-label text-primary">قيراط (إجمالي)</label><input type="number" class="form-control" id="qirat" value="0" max="23"></div>
            <div class="col-md-2 col-4"><label class="form-label text-primary">سهم (إجمالي)</label><input type="number" class="form-control" id="sahm" value="0" max="23"></div>
            <div class="col-12"><hr></div>
            <div class="col-md-6"><label class="form-label text-danger">التعديات (إن وجد)</label><input type="text" class="form-control" id="encroachment" placeholder="اكتب نوع التعدي أو اتركها فارغة"></div>
            <div class="col-md-6"><label class="form-label">واضع اليد</label><input type="text" class="form-control" id="squatter"></div>
            <div class="col-12"><label class="form-label">الموقع العام على الخريطة</label>
              <div class="input-group">
                <input type="text" class="form-control" id="locationUrl" placeholder="رابط خرائط جوجل">
                <button class="btn btn-outline-success" type="button" onclick="getGPS()"><i class="bi bi-geo-alt-fill"></i> موقعي الحالي</button>
              </div>
            </div>
            <div class="col-12"><label class="form-label">ملاحظات إضافية</label><textarea class="form-control" id="notes" rows="2"></textarea></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-success" onclick="submitData()">حفظ البيانات</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title fw-bold"><i class="bi bi-list-columns-reverse"></i> تفاصيل قطع الأراضي للمستأجر: <span id="detailsTenantName" class="badge bg-light text-dark"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-end mb-3">
          <button class="btn btn-success" onclick="prepareAddDetail()"><i class="bi bi-plus-lg"></i> إضافة قطعة جديدة</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover">
            <thead>
              <tr class="table-primary">
                <th>الناحية</th>
                <th>الحوض</th>
                <th>فدان</th>
                <th>قيراط</th>
                <th>سهم</th>
                <th>الموقع</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="areaDetailsTableBody">
              </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="parcelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="parcelModalTitle">إضافة قطعة أرض جديدة</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="parcelForm">
          <input type="hidden" id="detailSheetRowIndex">
          <input type="hidden" id="currentDetailTenantName">

          <div class="mb-3"><label class="form-label">الناحية/القرية</label><input type="text" class="form-control" id="detailDistrict" required></div>
          <div class="mb-3"><label class="form-label">الحوض/القطعة</label><input type="text" class="form-control" id="detailBasin" required></div>
          
          <div class="row g-3 mb-3">
            <div class="col-4"><label class="form-label text-primary">فدان</label><input type="number" class="form-control" id="detailFeddan" value="0"></div>
            <div class="col-4"><label class="form-label text-primary">قيراط</label><input type="number" class="form-control" id="detailQirat" value="0" max="23"></div>
            <div class="col-4"><label class="form-label text-primary">سهم</label><input type="number" class="form-control" id="detailSahm" value="0" max="23"></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">الموقع على الخريطة</label>
            <div class="input-group">
              <input type="text" class="form-control" id="detailLocationUrl" placeholder="رابط خرائط جوجل أو جوجل إيرث">
              </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-success" onclick="submitAreaDetail()">حفظ القطعة</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let globalData = [];
let currentTenant = ''; // لتخزين اسم المستأجر الحالي الذي يتم عرض تفاصيله

window.onload = function() { loadData(); };

function loadData() {
  document.getElementById('loadingSpinner').style.display = 'flex';
  google.script.run.withSuccessHandler(renderData).getData();
}

function renderData(data) {
  globalData = data;
  filterAndRender();
  calculateStats(data);
  document.getElementById('loadingSpinner').style.display = 'none';
}

function filterAndRender() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const issueFilter = document.getElementById('filterIssue').value;
  const container = document.getElementById('dataContainer');
  container.innerHTML = '';

  let filtered = globalData.map((row,index)=>({row,index})).filter(item=>{
    const str = item.row.join(' ').toLowerCase();
    const hasIssue = item.row[6] && item.row[6].toString().trim() !== '';
    const matchSearch = str.includes(searchTerm);
    let matchFilter = true;
    if(issueFilter==='issue') matchFilter = hasIssue;
    if(issueFilter==='clean') matchFilter = !hasIssue;
    return matchSearch && matchFilter;
  });

  if(filtered.length===0) { container.innerHTML='<div class="text-center text-muted mt-5"><h5>لا توجد بيانات مطابقة</h5></div>'; return; }

  filtered.forEach(item=>{
    const r=item.row, rowIndex=item.index, hasIssue=r[6] && r[6].toString().trim()!=='';
    // للتعامل مع الأسماء التي تحتوي على علامات تنصيص
    const escapedTenantName = r[1].replace(/'/g, "\\'"); 
    const cardHtml = `
      <div class="col-md-6 col-lg-4">
        <div class="data-card ${hasIssue?'has-issues':''}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="fw-bold text-success m-0">${r[1]}</h5> <span class="badge bg-secondary">${r[0]}</span>
          </div>
          <div class="mb-1"><i class="bi bi-geo-alt text-muted"></i> ${r[2]}</div>
          <div class="d-flex gap-3 my-2 border-top border-bottom py-2 bg-light rounded justify-content-center">
            <div class="text-center"><small>فدان</small><div class="fw-bold">${r[5]}</div></div>
            <div class="text-center"><small>قيراط</small><div class="fw-bold">${r[4]}</div></div>
            <div class="text-center"><small>سهم</small><div class="fw-bold">${r[3]}</div></div>
          </div>
          ${hasIssue?`<div class="alert alert-danger py-1 px-2 mb-2"><small><i class="bi bi-exclamation-circle"></i> <b>تعدي:</b> ${r[6]}</small></div>`:''}
          ${r[7]?`<div class="mb-1"><small class="text-muted">واضع اليد:</small> <b>${r[7]}</b></div>`:''}
          <div class="d-flex justify-content-between mt-3">
             <div>${r[8]?`<a href="${r[8]}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-map"></i> الموقع العام</a>`:''}</div>
             <div>
                <button class="btn btn-sm btn-info text-white ms-1" onclick="showAreaDetails('${escapedTenantName}')"><i class="bi bi-list-columns-reverse"></i> التفاصيل</button>
                <button class="btn btn-sm btn-warning text-white ms-1" onclick="editRecord(${rowIndex})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteRecord(${rowIndex})"><i class="bi bi-trash"></i></button>
             </div>
          </div>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend',cardHtml);
  });
}

function calculateStats(data){
  document.getElementById('totalTenants').innerText = data.length;
  let totalAcres=0, totalIssues=0;
  data.forEach(row=>{
    totalAcres+=parseFloat(row[5]||0);
    if(row[6] && row[6].toString().trim()!=='') totalIssues++;
  });
  document.getElementById('totalAcres').innerText = totalAcres.toFixed(2);
  document.getElementById('totalIssues').innerText = totalIssues;
}

function getGPS(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(position=>{
      const link=`https://www.google.com/maps/search/?api=1&query=${position.coords.latitude},${position.coords.longitude}`;
      document.getElementById('locationUrl').value=link;
      Swal.fire('تم!','تم تحديد موقعك بنجاح.','success');
    },()=>{Swal.fire('خطأ','تعذر الوصول للموقع','error');});
  } else Swal.fire('خطأ','المتصفح لا يدعم تحديد الموقع','error');
}

function prepareAdd(){
  document.getElementById('rentForm').reset();
  document.getElementById('rowIndex').value='';
  document.getElementById('modalTitle').innerText='إضافة إيجار جديد';
}

function editRecord(index){
  const row=globalData[index];
  document.getElementById('rowIndex').value=index;
  document.getElementById('journal').value=row[0];
  document.getElementById('tenantName').value=row[1];
  document.getElementById('district').value=row[2];
  document.getElementById('sahm').value=row[3];
  document.getElementById('qirat').value=row[4];
  document.getElementById('feddan').value=row[5];
  document.getElementById('encroachment').value=row[6];
  document.getElementById('squatter').value=row[7];
  document.getElementById('locationUrl').value=row[8];
  document.getElementById('notes').value=row[9];
  document.getElementById('modalTitle').innerText='تعديل بيانات: '+row[1];
  new bootstrap.Modal(document.getElementById('dataModal')).show();
}

function submitData(){
  const qiratValue=parseInt(document.getElementById('qirat').value);
  if(qiratValue>=24){Swal.fire('خطأ في المساحة','القيراط يجب أن يكون أقل من 24.','error'); return;}

  const record=[
    document.getElementById('journal').value,
    document.getElementById('tenantName').value,
    document.getElementById('district').value,
    document.getElementById('sahm').value,
    document.getElementById('qirat').value,
    document.getElementById('feddan').value,
    document.getElementById('encroachment').value,
    document.getElementById('squatter').value,
    document.getElementById('locationUrl').value,
    document.getElementById('notes').value
  ];

  const rowIndex=document.getElementById('rowIndex').value;
  bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
  Swal.fire({title:'جاري الحفظ...',didOpen:()=>Swal.showLoading()});

  if(rowIndex===''){
    google.script.run.withSuccessHandler(res=>{Swal.fire('تم!',res,'success'); loadData();}).addData(record);
  } else {
    google.script.run.withSuccessHandler(res=>{Swal.fire('تم!',res,'success'); loadData();}).updateData(rowIndex,record);
  }
}

function deleteRecord(index){
  Swal.fire({
    title:'هل أنت متأكد من الحذف؟',
    icon:'warning',
    showCancelButton:true,
    confirmButtonColor:'#d33',
    cancelButtonColor:'#3085d6',
    confirmButtonText:'نعم، احذفه!',
    cancelButtonText:'إلغاء'
  }).then(result=>{
    if(result.isConfirmed){
      Swal.fire({title:'جارٍ الحذف...',didOpen:()=>Swal.showLoading()});
      google.script.run.withSuccessHandler(res=>{Swal.fire('تم!',res,'success'); loadData();}).deleteData(index);
    }
  });
}

// -----------------------------------------------------------
// NEW FUNCTIONS FOR AREA DETAILS MANAGEMENT
// -----------------------------------------------------------

function showAreaDetails(tenantName) {
  currentTenant = tenantName; // حفظ اسم المستأجر الحالي
  document.getElementById('detailsTenantName').innerText = tenantName;
  new bootstrap.Modal(document.getElementById('detailsModal')).show();
  
  // عرض شاشة التحميل داخل الـ Modal
  const tableBody = document.getElementById('areaDetailsTableBody');
  tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">جاري جلب تفاصيل المساحات...</td></tr>';

  // استدعاء دالة Apps Script لجلب تفاصيل المساحات
  google.script.run.withSuccessHandler(renderAreaDetailsTable).getAreaDetails(tenantName);
}

function renderAreaDetailsTable(data) {
  const tableBody = document.getElementById('areaDetailsTableBody');
  tableBody.innerHTML = '';

  if (data.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-3">لا توجد قطع أراضٍ مسجلة لهذا المستأجر.</td></tr>';
    return;
  }

  data.forEach(item => {
    // item[0] هو رقم الصف الفعلي في شيت التفاصيل (sheetRowIndex)
    // item[1] هو الناحية، item[2] هو الحوض، item[3] سهم، item[4] قيراط، item[5] فدان، item[6] الموقع (رابط)
    const [sheetRowIndex, detailDistrict, detailBasin, detailSahm, detailQirat, detailFeddan, detailLocationUrl] = item;
    
    const rowHtml = `
      <tr>
        <td>${detailDistrict}</td>
        <td>${detailBasin}</td>
        <td>${detailFeddan}</td>
        <td>${detailQirat}</td>
        <td>${detailSahm}</td>
        <td>
          ${detailLocationUrl? `<a href="${detailLocationUrl}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-globe"></i> الموقع</a>` : 'لا يوجد موقع'}
        </td>
        <td>
          <button class="btn btn-sm btn-warning text-white" onclick="editAreaDetailRecord('${sheetRowIndex}', '${detailDistrict}', '${detailBasin}', '${detailSahm}', '${detailQirat}', '${detailFeddan}', '${detailLocationUrl}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger" onclick="deleteAreaDetailRecord('${sheetRowIndex}')"><i class="bi bi-trash"></i></button>
        </td>
      </tr>
    `;
    tableBody.insertAdjacentHTML('beforeend', rowHtml);
  });
}

function prepareAddDetail() {
  document.getElementById('parcelForm').reset();
  document.getElementById('detailSheetRowIndex').value = '';
  document.getElementById('currentDetailTenantName').value = currentTenant;
  document.getElementById('parcelModalTitle').innerText = 'إضافة قطعة أرض جديدة';

  // إخفاء modal التفاصيل وفتح modal القطعة
  bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
  new bootstrap.Modal(document.getElementById('parcelModal')).show();
}

function editAreaDetailRecord(sheetRowIndex, district, basin, sahm, qirat, feddan, locationUrl) {
  document.getElementById('detailSheetRowIndex').value = sheetRowIndex;
  document.getElementById('currentDetailTenantName').value = currentTenant;
  document.getElementById('detailDistrict').value = district;
  document.getElementById('detailBasin').value = basin;
  document.getElementById('detailSahm').value = sahm;
  document.getElementById('detailQirat').value = qirat;
  document.getElementById('detailFeddan').value = feddan;
  document.getElementById('detailLocationUrl').value = locationUrl;
  document.getElementById('parcelModalTitle').innerText = 'تعديل قطعة أرض: ' + basin;

  // إخفاء modal التفاصيل وفتح modal القطعة
  bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
  new bootstrap.Modal(document.getElementById('parcelModal')).show();
}

function submitAreaDetail() {
  const qiratValue = parseInt(document.getElementById('detailQirat').value);
  if (qiratValue >= 24) { Swal.fire('خطأ في المساحة', 'القيراط يجب أن يكون أقل من 24.', 'error'); return; }
  
  const tenantName = document.getElementById('currentDetailTenantName').value;

  const record = [
    tenantName, // يتم تمرير اسم المستأجر لربط القطعة
    document.getElementById('detailDistrict').value,
    document.getElementById('detailBasin').value,
    document.getElementById('detailSahm').value,
    document.getElementById('detailQirat').value,
    document.getElementById('detailFeddan').value,
    document.getElementById('detailLocationUrl').value
  ];

  const sheetRowIndex = document.getElementById('detailSheetRowIndex').value;
  bootstrap.Modal.getInstance(document.getElementById('parcelModal')).hide();
  Swal.fire({ title: 'جاري الحفظ...', didOpen: () => Swal.showLoading() });

  if (sheetRowIndex === '') {
    // إضافة جديدة
    google.script.run.withSuccessHandler(res => {
      Swal.fire('تم!', res, 'success');
      showAreaDetails(currentTenant); // إعادة عرض التفاصيل المحدثة
    }).addAreaDetail(record);
  } else {
    // تعديل
    google.script.run.withSuccessHandler(res => {
      Swal.fire('تم!', res, 'success');
      showAreaDetails(currentTenant); // إعادة عرض التفاصيل المحدثة
    }).updateAreaDetail(sheetRowIndex, record);
  }
}

function deleteAreaDetailRecord(sheetRowIndex) {
  Swal.fire({
    title: 'هل أنت متأكد من حذف هذه القطعة؟',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'نعم، احذفها!',
    cancelButtonText: 'إلغاء'
  }).then(result => {
    if (result.isConfirmed) {
      Swal.fire({ title: 'جارٍ الحذف...', didOpen: () => Swal.showLoading() });
      google.script.run.withSuccessHandler(res => {
        Swal.fire('تم!', res, 'success');
        showAreaDetails(currentTenant); // إعادة عرض التفاصيل المحدثة
      }).deleteAreaDetail(sheetRowIndex);
    }
  });
}

document.getElementById('searchInput').addEventListener('input',filterAndRender);
document.getElementById('filterIssue').addEventListener('change',filterAndRender);
</script>

</body>
</html>
